<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/productDetail.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="productDetail-container">
        <div class="productDetail-inner">
            <!-- ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ -->
            <div class="product-image">
                <div class="slider">
                    <img th:each="imgUrl : ${product_images}"  th:src="@{${'/product-images/' + imgUrl}}" alt="">
                </div>

                <button id="prev" class="prev">Ïù¥Ï†Ñ</button>
                <button id="next" class="next">Îã§Ïùå</button>

                <!-- ÎèôÍ∑∏ÎùºÎØ∏ Î≤ÑÌäºÎì§ -->
                <div class="dots-container">
                    <span class="dot" th:each="i : ${#numbers.sequence(0, product_images.length - 1)}"></span>
                </div>
            </div>

            <!-- ÏÉÅÌíà Ï†ïÎ≥¥ -->
            <div class="product-info">
                <!-- ÏÉÅÌíàÎ™Ö + Ï∞ú Î≤ÑÌäº -->
                <div class="product-header">
                    <span class="product-name" th:text="${product.productName}"></span>
                    <div class="product-like">
                        <button class="wishlist-btn">üñ§</button>
                        <span class="product-like-count" th:text="${product.product_like}"></span>
                    </div>
                </div>
                <hr>

                <!-- ÏÉÅÌíà ÏÑ§Î™Ö -->
                <div class="product-description" th:text="${product.productContent}"></div>
                <hr>

                <!-- ÏÉÅÌíà Í∞ÄÍ≤© -->
                <div class="product-price" th:text="${#numbers.formatInteger(product.product_price, 3, 'COMMA') + ' Ïõê'}"></div>
                <hr>
                <form action="/productBuy" method="post">
                <!-- ÏàòÎüâ ÏÑ†ÌÉù -->
                <div class="quantity-container">
                    <!--      ÎÇ®ÏùÄ Ïû¨Í≥† ÏàòÎüâ      -->
                    <input type="hidden" id="stockCount" th:value="${product.product_pcs}">
                    <!--      Íµ¨Îß§ ÌïòÎäî ÏÉÅÌíà Î≤àÌò∏  -->
                    <input type="hidden" name="product_buy_productidx" th:value="${product.product_idx}" >
                    <!-- Íµ¨Îß§ÌïòÎäî ÏÉÅÌíà ÏàòÎüâ  -->
                    <input type="hidden" name="quantity" id="quantityInput" value="0">
                    <span>Ï¥ù ÏÉÅÌíà Í∏àÏï°(ÏàòÎüâ): </span>
                    <span class="total-price">0</span> Ïõê
                    (<span class="quantity-count">0</span>Í∞ú)
                    <p class="min-order-text">(ÏµúÏÜå Ï£ºÎ¨∏ 1Í∞ú Ïù¥ÏÉÅ)
                        <!-- Ïû¨Í≥†Í∞Ä 5Í∞ú Ïù¥ÌïòÏùº ÎïåÎßå ÌëúÏãú -->
                        <span th:if="${product.product_pcs <= 5 and product.product_pcs > 0}"
                              class="low-stock" style="color: red; font-weight: bold;">
                            üö® ÎÇ®ÏùÄ Ïû¨Í≥†: <span th:text="${product.product_pcs}"></span> Í∞ú
                        </span>

                        <!-- Ïû¨Í≥†Í∞Ä 0Ïù¥Î©¥ 'ÌíàÏ†à' ÌëúÏãú -->
                        <span th:if="${product.product_pcs == 0}" class="sold-out" style="color: gray; font-weight: bold;">
                            ‚ùå ÌíàÏ†à
                        </span>
                    </p>

                    <div class="quantity-buttons">
                        <button type="button" class="quantity-btn minus" onclick="updateQuantity(-1)">Ôºç</button>
                        <span class="quantity">0</span> <!-- Ï¥àÍ∏∞Í∞í 1 -->
                        <button type="button" class="quantity-btn plus" onclick="updateQuantity(1)">Ôºã</button>
                    </div>
                </div>
                <hr>

                <!-- Ïû•Î∞îÍµ¨Îãà & Íµ¨Îß§ÌïòÍ∏∞ -->
                <div class="product-actions">
                    <button type="submit" class="cart-btn" id="cartButton" name="action" data-action="cart" value="cart">Ïû•Î∞îÍµ¨Îãà</button>
                    <button type="submit" class="buy-btn" id="buyButton" name="action" data-action="buy" value="buy">Íµ¨Îß§ÌïòÍ∏∞</button>
                </div>
                </form>
            </div>
        </div>


        <!-- ÏÉÅÏÑ∏Ï†ïÎ≥¥, Íµ¨Îß§Ìèâ, Q&A -->
        <div class="product-tabs">
            <button class="tab-link" onclick="scrollToSection('detail-section')">ÏÉÅÏÑ∏Ï†ïÎ≥¥</button>
            <button class="tab-link" onclick="scrollToSection('review-section')">Íµ¨Îß§Ìèâ
                <span class="totalElements" th:text="${reviews.totalElements}"></span>
            </button>
            <button class="tab-link" onclick="scrollToSection('qna-section')">Q&A
                <span class="totalElements" th:text="${#lists.size(question_list)}"></span>
            </button>
        </div>

        <div id="detail-section" class="product-section">
            <h2>ÏÉÅÏÑ∏Ï†ïÎ≥¥</h2>
            <p>Ïó¨Í∏∞Ïóê ÏÉÅÌíà ÏÉÅÏÑ∏ Ï†ïÎ≥¥Í∞Ä Îì§Ïñ¥Í∞ëÎãàÎã§.</p>
        </div>
        <!-- ÎåìÍ∏Ä Î∂ÄÎ∂ÑÏûÖÎãàÎã§.    -->
        <div id="review-section" class="product-section">
            <div class="review-head-menu">
                <h2>Íµ¨Îß§Ìèâ</h2>
                <span class="review-totalElements" th:text="${reviews.totalElements}"></span>
                <div class="review-sort">
                    <select id="sort" name="sort" onchange="changeSort()" required="required">
                        <option value="latest" th:selected="${sort == 'latest'}">ÏµúÏã† Ïàú</option>
                        <option value="likest" th:selected="${sort == 'likest'}">Ï∞úÌïòÍ∏∞ Ïàú</option>
                    </select>
                </div>
            </div>

            <div class="review-container" th:each="review : ${reviews}">
                <div class="review-item">
                    <div class="review-left">
                        <img th:src="@{${'/profile-images/' + reviewUserImage[review.getReviewIdx]}}" alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ" class="profile-img">
                    </div>
                    <div class="review-content">
                        <div class="review-header">
                            <div class="review-stars" th:switch="${#numbers.formatInteger(review.reviewScope, 0)}">
                                <span th:case="1">‚≠ê</span>
                                <span th:case="2">‚≠ê‚≠ê</span>
                                <span th:case="3">‚≠ê‚≠ê‚≠ê</span>
                                <span th:case="4">‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                <span th:case="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                            </div>
                            <div class="review-user-info">
                                <span class="review-username" th:text="${reviewUserName[review.reviewIdx]}"></span> |
                                <span class="review-date" th:text="${review.reviewAt}"></span> |
                                <span class="review-option" th:text="${product.productName}"></span>
                            </div>
                        </div>
                        <div class="review-text" th:text="${review.reviewContent}">
                        </div>
                    </div>
                    <div th:if="${reviewimages.containsKey(review.reviewIdx) and reviewimages[review.reviewIdx].length > 0}">
                        <img th:src="@{'/review-images/' + ${reviewimages[review.reviewIdx][0]}}"
                             alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                             class="review-img"
                             onclick="openModel()">
                    </div>
                    <div class="like-button review-wishlist-btn">
                        <span>üñ§</span> <!-- Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ï∞úÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú -->
                        <input type="hidden" name="review_idx" th:value="${review.reviewIdx}">
                        <span class="review-like-count" th:text="${review.reviewLike}"></span>
                    </div>
                </div>

                <!-- Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ -->
                <div id="image-modal" class="modal"  th:if="${reviewimages.containsKey(review.reviewIdx)}">
                    <div class="modal-inner">
                        <span class="close" onclick="closeModel()" >&times;</span>
                        <div class="modal-container-img">
                            <img th:each="image : ${reviewimages[review.reviewIdx]}"
                                 th:src="@{'/review-images/' + ${image}}"
                                 alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                                 class="modal-content" id="modal-img">
                        </div>
                        <img id="review-prev" class="review-prev" th:src="@{/local-images/left-arrow.png}" alt="">
                        <img id="review-next" class="review-next" th:src="@{/local-images/right-arrow.png}" alt="">
                        <div class="review-dots">
                            <span class="review-dot" th:each="i : ${#numbers.sequence(0, reviewimages[review.reviewIdx].length - 1)}"></span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Î¶¨Î∑∞Í∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ Î©îÏãúÏßÄ ÌëúÏãú -->
            <div th:if="${reviews.totalElements == 0}" class="no-reviews">
                ÏïÑÏßÅ Î¶¨Î∑∞Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.
            </div>

            <div class="pagination" th:if="${reviews.totalPages > 0}">
                <ul>
                    <li th:each="i : ${#numbers.sequence(0, reviews.totalPages - 1)}">
                        <a th:href="@{/productDetail/{product_idx}(product_idx=${product.product_idx}, page=${i}, sort=${sort})}"
                           th:text="${i + 1}"
                           th:classappend="${i == reviews.number ? 'active' : ''}"></a>
                    </li>
                </ul>
            </div>
            <!-- ÎåìÍ∏Ä ÌéòÏù¥ÏßÄ ÎÑ§Ïù¥ÏÖò Î∂ÄÎ∂Ñ Îã§Ïùå Î∞è Ï†ÑÏúºÎ°ú Í∞ÄÍ∏∞ -->
            <div class="review-page-left">
                <li th:if="${reviews.hasPrevious()}">
                    <a th:href="@{/productDetail/{product_idx}(product_idx=${product.product_idx}, page=${reviews.number - 1}, sort=${sort})}">
                        <img th:src="@{/local-images/left.png}" alt="">
                    </a>
                </li>
            </div>
            <div class="review-page-right">
                <li th:if="${reviews.hasNext()}">
                    <a th:href="@{/productDetail/{product_idx}(product_idx=${product.product_idx}, page=${reviews.number + 1}, sort=${sort})}">
                        <img th:src="@{/local-images/right.png}" alt="">
                    </a>
                </li>
            </div>
        </div>
        <!-- ÏßàÎ¨∏ Îì±Î°ùÌïòÍ∏∞ QnA-->
        <div id="qna-section" class="product-section">
            <div class="review-head-menu">
                <h2>Q&A</h2>
                <div class="review-sort" th:if="${#authorization.expression('isAuthenticated()')}">
                    <button class="question-btn" id="toggle-qna" sec:authorize="isAuthenticated()" >ÏßàÎ¨∏Îì±Î°ù</button>
                </div>
            </div>
            <!-- ÏßàÎ¨∏ Îì±Î°ùÌïòÍ∏∞ QnA-->
            <div class="qna-content">
                <form th:action="@{/product_question}" method="post" th:object="${product_question}">
                    <div class="question-regist">
                        <span class="question-content">ÏßàÎ¨∏ : ÎÇ¥Ïö©</span>
                        <input type="hidden" name="productQuestionProductidx" th:value="${product.product_idx}">
                        <input type="text" th:field="*{productQuestionContent}">
                        <button type="submit">ÏûëÏÑ±ÏôÑÎ£å</button>
                    </div>
                </form>
            </div>

            <div class="review-container">
                <div class="question-list" th:each="question ,stauts : ${question_list}">
                    <div class="question-item">
                        <div class="question-list-top">
                            <span class="question-content" th:text="${stauts.index + 1} + '.'"></span>
                            <span class="question-content" th:text="'ÏûëÏÑ±Ïûê : [' + ${question_name[question.productQuestionIdx]} + ']'"></span>
                            <button class="answer-regist answer-btn"
                                    th:if="${product.product_user == userid and answer_list[question.productQuestionIdx] == 'ÎãµÎ≥ÄÏù¥ ÏóÜÏäµÎãàÎã§.'}">
                                ÎãµÎ≥Ä
                            </button>

                        </div>
                        <div>
                            <span class="question-content">ÏßàÎ¨∏ ÎÇ¥Ïö© : </span>
                            <span class="question-content question-css" th:text="${question.productQuestionContent}"></span>
                        </div>
                    </div>
                    <div class="answer">
                        <form th:action="@{/product_answer}" method="post" th:object="${product_answer}" >
                            <input type="hidden" name="productAnswerQuestionidx" th:value="${question.productQuestionIdx}">
                            <input type="text" placeholder="adminÎßå ÏûëÏÑ±Í∞ÄÎä•" th:field="*{productAnswerContent}">
                            <button type="submit">Îì±Î°ùÌïòÍ∏∞</button>
                        </form>
                    </div>
                    <div class="answer-list" th:if="${answer_list[question.productQuestionIdx] != 'ÎãµÎ≥ÄÏù¥ ÏóÜÏäµÎãàÎã§.'}">
                        <span>ÎãµÎ≥Ä : </span>
                        <span th:text="${answer_list[question.productQuestionIdx]}"></span>
                    </div>
                </div>
                <!-- QnA ÏóÜÏùÑ Í≤ΩÏö∞ Î©îÏãúÏßÄ ÌëúÏãú -->
                <div th:if="${#lists.isEmpty(question_list)}" class="no-reviews">
                    ÏïÑÏßÅ ÏÉÅÌíà QnA Ìï≠Î™©Ïù¥ Ï°¥Ïû¨ ÌïòÏßÄ ÏïäÏäµÎãàÎã§.
                </div>
            </div>
        </div>
    </div>

</th:block>
</body>
</html>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const qnaContent = document.querySelector(".qna-content");
        const toggleQnaBtn = document.getElementById("toggle-qna");
        const answerButtons = document.querySelectorAll(".answer-regist");

        // ÏßàÎ¨∏Îì±Î°ù Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú qna-content ÌëúÏãú/Ïà®ÍπÄ
        toggleQnaBtn.addEventListener("click", function () {
            qnaContent.style.display = (qnaContent.style.display === "flex") ? "none" : "flex";
        });

        // Í∞Å ÏßàÎ¨∏Ïùò ÎãµÎ≥Ä Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ìï¥Îãπ answer ÏòÅÏó≠ ÌëúÏãú/Ïà®ÍπÄ
        answerButtons.forEach(button => {
            button.addEventListener("click", function () {
                const answerBox = this.closest(".question-list").querySelector(".answer");
                answerBox.style.display = (answerBox.style.display === "flex") ? "none" : "flex";
            });
        });
    });

    // ÏÉÅÌíà Íµ¨Îß§ Î∞è Ïû•Î∞îÍµ¨Îãà Íµ¨ÌòÑ
    document.querySelectorAll(".buy-btn, .cart-btn").forEach(button => {
        button.addEventListener("click", function (event) {
            event.preventDefault();

            const productIdx = document.querySelector("input[name='product_buy_productidx']").value;
            const quantityElement = document.querySelector(".quantity");
            const quantity = quantityElement ? quantityElement.textContent.trim() : "0"; // Í∞íÏù¥ ÏóÜÏúºÎ©¥ "0"ÏúºÎ°ú ÏÑ§Ï†ï
            const action = button.getAttribute("data-action");

            console.log("Î≥¥ÎÇ¥Îäî quantity Í∞í:", quantity); // ÏàòÎüâ Í∞í ÌôïÏù∏

            fetch("/productBuy", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `product_buy_productidx=${productIdx}&quantity=${quantity}&action=${action}`
            })
                .then(response => response.json().then(data => {

                    if (response.status === 401 || data.message === "Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.") {
                        alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                        window.location.href = "/login";
                        return null;
                    } else if (response.status === 400 && data.message === "ÏàòÎüâÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.") {
                        alert("ÏàòÎüâÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                        return null;
                    }
                    return data;
                }))
                .then(data => {
                    if (data && data.status === "success") {
                        if(action === "cart"){
                            alert("Ïû•Î∞îÍµ¨ÎãàÏóê Îì±Î°ùÎêòÏóàÏäµÎãàÎã§");
                        }else {
                            alert("Íµ¨Îß§ ÎêòÏóàÏäµÎãàÎã§");
                        }
                        window.location.href = action === "cart" ? "/cart" : "/product_list";
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                });
        });
    });


    let quantity = 0;
    const pricePerItem = parseInt(document.querySelector('.product-price').textContent.replace(/[^0-9]/g, ''), 10);

    // ÌíàÏ†àÎêòÍ±∞ÎÇò ÏàòÎüâÏùÑ ÎÇòÌÉÄÎÇ¥Îäî JS
    function updateQuantity(change) {
        // maxStock = Ïû¨Í≥† ÏàòÎüâ Ï†ÄÏû•
        const maxStock = parseInt(document.getElementById("stockCount").value, 10); // ÌòÑÏû¨ Ïû¨Í≥† ÏàòÎüâ Í∞ÄÏ†∏Ïò§Í∏∞
        quantity = Math.max(0, quantity + change); // ÏµúÏÜå 0Í∞ú Ïú†ÏßÄ

        const cartBtn = document.querySelector("#cartButton");
        const buyBtn = document.querySelector("#buyButton");

        // ÌíàÏ†à ÏÉÅÌÉúÎ©¥ ÏàòÎüâ Î≥ÄÍ≤Ω Î∂àÍ∞ÄÎä•
        if (maxStock === 0) {
            alert("‚ùå ÌíàÏ†àÎêú ÏÉÅÌíàÏûÖÎãàÎã§.");

            // Ïû•Î∞îÍµ¨Îãà Î≤ÑÌäº ÎπÑÌôúÏÑ±ÌôîÌïòÍ≥† ÌöåÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
            cartBtn.disabled = true;  // ÌÅ¥Î¶≠ Î∂àÍ∞ÄÎä•ÌïòÍ≤å ÎßåÎì§Í∏∞
            cartBtn.style.backgroundColor = "#d3d3d3"; // ÌöåÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
            cartBtn.style.cursor = "not-allowed"; // Ïª§ÏÑú Î≥ÄÍ≤Ω

            // Íµ¨Îß§ÌïòÍ∏∞ Î≤ÑÌäº ÎπÑÌôúÏÑ±ÌôîÌïòÍ≥† ÌöåÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
            buyBtn.disabled = true; // Íµ¨Îß§ÌïòÍ∏∞ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            buyBtn.style.backgroundColor = "#d3d3d3"; // ÌöåÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
            buyBtn.style.cursor = "not-allowed"; // Ïª§ÏÑú Î≥ÄÍ≤Ω

            return;
        } else {
            // Ïû¨Í≥†Í∞Ä ÏûàÏúºÎ©¥ Î≤ÑÌäºÏùÑ ÌôúÏÑ±ÌôîÌïòÍ≥† Í∏∞Î≥∏ ÏÉâÏÉÅ Î≥µÏõê
            cartBtn.disabled = false;  // ÌÅ¥Î¶≠ Í∞ÄÎä•ÌïòÍ≤å ÎßåÎì§Í∏∞
            cartBtn.style.backgroundColor = "#3498db"; // Í∏∞Î≥∏ Î∞∞Í≤ΩÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
            cartBtn.style.cursor = "pointer"; // Ïª§ÏÑú Î≥ÄÍ≤Ω

            buyBtn.disabled = false; // Íµ¨Îß§ÌïòÍ∏∞ Î≤ÑÌäº ÌôúÏÑ±Ìôî
            buyBtn.style.backgroundColor = "#2ecc71"; // Í∏∞Î≥∏ Î∞∞Í≤ΩÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
            buyBtn.style.cursor = "pointer"; // Ïª§ÏÑú Î≥ÄÍ≤Ω
        }

        // Ïû¨Í≥†Î≥¥Îã§ ÎßéÏù¥ ÏÑ†ÌÉùÌïòÎ©¥ Í≤ΩÍ≥† ÌõÑ Î≥ÄÍ≤Ω Ïïà Ìï®
        if (quantity > maxStock) {
            alert(`üö® ÏµúÎåÄ ${maxStock}Í∞úÍπåÏßÄÎßå Íµ¨Îß§Ìï† Ïàò ÏûàÏäµÎãàÎã§.`);
            quantity = maxStock; // ÏµúÎåÄ ÏàòÎüâÏúºÎ°ú Ï°∞Ï†ï
        }

        // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        document.querySelector('.quantity').textContent = quantity;
        document.querySelector('.quantity-count').textContent = quantity;
        document.querySelector('.total-price').textContent = (pricePerItem * quantity).toLocaleString();
        document.getElementById('quantityInput').value = quantity;
    }

    // ÏÉÅÌíà ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï∞úÌïòÍ∏∞ API
    document.addEventListener("DOMContentLoaded", function () {
        const btn = document.querySelector(".wishlist-btn");
        const productIdx = document.querySelector("input[name='product_buy_productidx']").value;
        const likeCountSpan = document.querySelector(".product-like-count"); // Ï¢ãÏïÑÏöî Í∞úÏàò ÌëúÏãúÌïòÎäî ÏöîÏÜå

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï∞ú ÏÉÅÌÉú ÌôïÏù∏ (GET ÏöîÏ≤≠)
        fetch(`/product/like-status/${productIdx}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "liked") {
                    btn.textContent = "‚ù§Ô∏è"; // Ï∞ú ÏÉÅÌÉúÏù∏ Í≤ΩÏö∞
                    likeCountSpan.textContent = data.likeCount; // Ï¢ãÏïÑÏöî Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
                } else if (data.status === "not_liked") {
                    btn.textContent = "üñ§"; // Ï∞ú ÏÉÅÌÉúÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞
                    likeCountSpan.textContent = data.likeCount; // Ï¢ãÏïÑÏöî Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
                }
            })
            .catch(error => console.error("Error:", error));

        // Ï∞ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌÜ†Í∏Ä (POST ÏöîÏ≤≠)
        btn.addEventListener("click", function () {
            fetch(`/product/like/${productIdx}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if(response.status === 401){
                        alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§");
                        window.location.href = "/login";
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === "added") {
                        btn.textContent = "‚ù§Ô∏è"; // Ï∞ú Ï∂îÍ∞ÄÎêú Í≤ΩÏö∞
                        likeCountSpan.textContent = parseInt(likeCountSpan.textContent) + 1; // Ïà´Ïûê Ï¶âÏãú Ï¶ùÍ∞Ä
                    } else if (data.status === "removed") {
                        btn.textContent = "üñ§"; // Ï∞ú Ï∑®ÏÜåÎêú Í≤ΩÏö∞
                        likeCountSpan.textContent = parseInt(likeCountSpan.textContent) - 1; // Ïà´Ïûê Ï¶âÏãú Í∞êÏÜå
                    }
                })
                .catch(error => console.error("Error:", error));
        });
    });


    // Ïù¥ÎØ∏ÏßÄ Ïä¨ÎùºÏù¥Îìú
    const prevButton = document.getElementById('prev');
    const nextButton = document.getElementById('next');
    const slider = document.querySelector('.slider');
    const dots = document.querySelectorAll('.dot');
    let currentIndex = 0;
    const images = slider.querySelectorAll('img');
    const totalImages = images.length;

    // ÎèôÍ∑∏ÎùºÎØ∏ Î≤ÑÌäº ÌôúÏÑ±Ìôî Ìï®Ïàò
    function updateDots() {
        dots.forEach((dot, index) => {
            dot.classList.remove('active');
            if (index === currentIndex) {
                dot.classList.add('active');
            }
        });
    }

    // Ïù¥Ï†Ñ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
    prevButton.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            slider.style.transform = `translateX(-${currentIndex * 400}px)`;
            updateDots();
        }
    });

    // Îã§Ïùå Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
    nextButton.addEventListener('click', () => {
        if (currentIndex < totalImages - 1) {
            currentIndex++;
            slider.style.transform = `translateX(-${currentIndex * 400}px)`;
            updateDots();
        }
    });

    // ÎèôÍ∑∏ÎùºÎØ∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            currentIndex = index;
            slider.style.transform = `translateX(-${currentIndex * 400}px)`;
            updateDots();
        });
    });

    // Ï¥àÍ∏∞ ÎèôÍ∑∏ÎùºÎØ∏ ÌôúÏÑ±Ìôî
    updateDots();


    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
    document.addEventListener("DOMContentLoaded", function() {
        updateQuantity(0); // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    });

    // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ , Íµ¨Îß§Ìèâ ,QnaÎ°ú Ï≤úÏ≤úÌûà Ïù¥Îèô
    function scrollToSection(sectionId) {
        document.getElementById(sectionId).scrollIntoView({ behavior: "smooth" });
    }
    <!-- Ïó¨Í∏∞ ÍπåÏßÄ ÏÉÅÌíà ÎîîÌÖåÏùº Ïóê Í¥ÄÌïú js -->

    // -------------------------------------------------------------- //

    <!-- Ïó¨Í∏∞ Ïù¥ÌõÑÎäî ÏÉÅÌíàÏóê ÎåÄÌïú Î¶¨Î∑∞  js -->
    const reviewPrev = document.getElementById("review-prev");
    const reviewNext = document.getElementById("review-next");
    const reviewSlider = document.querySelector(".modal-container-img");
    const reviewImages = reviewSlider.querySelectorAll("img");  // Ïó¨Îü¨ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉù
    const reviewDots = document.querySelectorAll(".review-dot");
    let reviewCurrentIndex = 0;
    const reviewLength = reviewImages.length;

    function updateReDots(){
        reviewDots.forEach((dot,index) => {
            dot.classList.remove('active');
           if(index === reviewCurrentIndex){
               dot.classList.add("active");
           }
        });
    }

    reviewPrev.addEventListener('click', () => {
        if(reviewCurrentIndex > 0){  // Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏßÄ ÏïäÎèÑÎ°ù Ï°∞Í±¥ Î≥ÄÍ≤Ω
            reviewCurrentIndex--;
            reviewSlider.style.transform = `translateX(-${reviewCurrentIndex * 400}px)`;  // Î∞±Ìã±(`) ÏÇ¨Ïö©
            updateReDots();
        }
    });

    reviewNext.addEventListener('click', () => {
        if(reviewCurrentIndex < reviewLength - 1){  // ÎÅùÍπåÏßÄ Í∞ÄÏßÄ ÏïäÎèÑÎ°ù Ï°∞Í±¥ Î≥ÄÍ≤Ω
            reviewCurrentIndex++;
            reviewSlider.style.transform = `translateX(-${reviewCurrentIndex * 400}px)`;  // Î∞±Ìã±(`) ÏÇ¨Ïö©
            updateReDots();
        }
    });

    // ÎèôÍ∑∏ÎùºÎØ∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
    reviewDots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            reviewCurrentIndex = index;
            reviewSlider.style.transform = `translateX(-${reviewCurrentIndex * 400}px)`;
            updateReDots();
        });
    });

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    updateReDots();

    // ÌÅ¥Î¶≠Ïãú Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ
    function openModel() {
        document.getElementById('image-modal').style.display = "flex";

    }

    // Ïù¥ÎØ∏ÏßÄ Îã´Í∏∞
    function closeModel() {
        document.getElementById('image-modal').style.display = "none";
    }

    // ESC ÌÇ§ ÎàåÎ†ÄÏùÑ Îïå Îã´Í∏∞
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModel();
        }
    });


    // ÏÉÅÌíà ÎåìÍ∏Ä Ï¢ãÏïÑÏöî API
    document.addEventListener("DOMContentLoaded", function () {
        const btns = document.querySelectorAll(".review-wishlist-btn");

        btns.forEach(btn => {
            const reviewproductIdx = btn.querySelector("input[name='review_idx']").value;
            const heartIcon = btn.querySelector("span"); // ‚ù§Ô∏è ÎòêÎäî üñ§ ÏïÑÏù¥ÏΩòÏùÑ Î≥ÄÍ≤ΩÌï† ÏöîÏÜå
            const likeCountSpan = btn.querySelector(".review-like-count"); // Ï¢ãÏïÑÏöî Í∞úÏàò ÌëúÏãúÌïòÎäî ÏöîÏÜå

            // Í∞úÎ≥Ñ Î¶¨Î∑∞Ïùò Ï∞ú ÏÉÅÌÉú Î∞è Í∞úÏàò ÌôïÏù∏ (GET ÏöîÏ≤≠)
            fetch(`/review/like-status/${reviewproductIdx}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            })
                .then(response => response.json())
                .then(data => {
                    heartIcon.textContent = data.status === "liked" ? "‚ù§Ô∏è" : "üñ§";
                    likeCountSpan.textContent = data.likeCount; // Ï¢ãÏïÑÏöî Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
                })
                .catch(error => console.error("Error:", error));

            // Í∞úÎ≥Ñ Ï∞ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            btn.addEventListener("click", function () {
                fetch(`/review/like/${reviewproductIdx}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                })
                    .then(response => {
                        if (response.status === 401) {
                            alert("Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.");
                            window.location.href = "/login";
                            return;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === "added") {
                            heartIcon.textContent = "‚ù§Ô∏è"; // Ï∞ú Ï∂îÍ∞ÄÎê®
                            likeCountSpan.textContent = parseInt(likeCountSpan.textContent) + 1; // Ïà´Ïûê Ï¶âÏãú Ï¶ùÍ∞Ä
                        } else if (data.status === "removed") {
                            heartIcon.textContent = "üñ§"; // Ï∞ú Ï∑®ÏÜåÎê®
                            likeCountSpan.textContent = parseInt(likeCountSpan.textContent) - 1; // Ïà´Ïûê Ï¶âÏãú Í∞êÏÜå
                        }
                    })
                    .catch(error => console.error("Error:", error));
            });
        });
    });


    // Ï†ïÎ†¨ Í∏∞Îä•
    // ÏÉÅÌíà ÎåìÍ∏Ä ÏÑ†ÌÉùÌïú Í∞í URLÎ°ú Î≥¥ÎÇ¥Í∏∞
    function changeSort() {
        let selectedSort = document.getElementById("sort").value;
        let currentUrl = new URL(window.location.href);

        currentUrl.searchParams.set("sort", selectedSort);  // sort ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä ÎòêÎäî Î≥ÄÍ≤Ω
        currentUrl.searchParams.set("page", 0); // Ï†ïÎ†¨ Î≥ÄÍ≤Ω Ïãú Ï≤´ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô


        window.location.href = currentUrl.toString(); // ÏÉà URLÎ°ú Ïù¥Îèô

    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï†ÄÏû•Îêú Ï†ïÎ†¨ Í∞í Ï†ÅÏö©
    document.addEventListener("DOMContentLoaded", function () {
        const sortSelect = document.getElementById("sort");

        // URLÏóêÏÑú Í≤ÄÏÉâÏñ¥(search)ÏôÄ Ï†ïÎ†¨Í∞í(sort)ÏùÑ Í∞ÄÏ†∏Ïò¥
        const urlParams = new URLSearchParams(window.location.search);
        const urlSort = urlParams.get("sort"); // URLÏóêÏÑú sort Í∞í Í∞ÄÏ†∏Ïò§Í∏∞


        // URLÏóêÏÑú sort Í∞íÏù¥ ÏûàÏúºÎ©¥ ÎìúÎ°≠Îã§Ïö¥Ïóê ÏÑ§Ï†ïÌïòÍ≥†, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        if (urlSort) {
            sortSelect.value = urlSort;
        } else {
            sortSelect.value = "latest"; // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        }
    });

</script>