<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/mypage.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="profile-container">
        <div>
            <h2>Mypage</h2>
        </div>

        <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄÏôÄ Ï†ïÎ≥¥ -->
        <div class="profile-warp">
            <div class="profile">
                <img th:src="@{${'/profile-images/' + UserImage}}" alt="Profile Image" />
                <div class="user-info">
                    <span class="username" th:text="${name}"></span>
                    <span class="role" th:text="${role}">ROLE_USER</span>
                </div>
                <div class="change-profile">
                    <a th:href="@{/snap}">Ïä§ÎÉÖ Î≥ÄÍ≤Ω</a>
                </div>
            </div>

            <!-- Ï¥ù Íµ¨Îß§ Í∏àÏï° -->
            <div class="section">
                <div class="section-title">Ï¥ù Íµ¨Îß§ Í∏àÏï° Î∞è ÏàòÎüâ</div>
                <div class="total-info">
                    <span class="total-price" th:text="${#numbers.formatInteger(totalPrice, 3, 'COMMA') + 'Ïõê'}"></span>
                    <span class="total-border">
                        <span class="total-quantity" th:text="${totalQuantity}"></span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Ï£ºÎ¨∏ ÎÇ¥Ïó≠ -->
        <div class="section order-history">
            <div class="section-title">Ï£ºÎ¨∏ ÎÇ¥Ïó≠</div>
            <div class="link"><a href="/cancel">Ï£ºÎ¨∏ ÍµêÌôò/Ï∑®ÏÜå ÎÇ¥Ïó≠</a></div>
            <div class="link"><a href="/order">Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î≥¥Í∏∞</a></div>
        </div>

        <!-- QnA ÎÇ¥Ïó≠ -->
        <div class="section qna-history">
            <div class="section-title">QnA ÎÇ¥Ïó≠</div>
            <div class="link">1:1 Í≥†Í∞ù ÏÑºÌÑ∞ Î≥¥Í∏∞</div>
            <div class="link">QnA ÎÇ¥Ïó≠ Î≥¥Í∏∞</div>
        </div>

    </div>

</th:block>
</body>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const btns = document.querySelectorAll(".review-wishlist-btn");

        btns.forEach(btn => {
            const reviewproductIdx = btn.querySelector("input[name='review_idx']").value;
            const heartIcon = btn.querySelector("span"); // ‚ù§Ô∏è ÎòêÎäî üñ§ ÏïÑÏù¥ÏΩòÏùÑ Î≥ÄÍ≤ΩÌï† ÏöîÏÜå
            const likeCountSpan = btn.querySelector(".review-like-count"); // Ï¢ãÏïÑÏöî Í∞úÏàò ÌëúÏãúÌïòÎäî ÏöîÏÜå

            // Í∞úÎ≥Ñ Î¶¨Î∑∞Ïùò Ï∞ú ÏÉÅÌÉú Î∞è Í∞úÏàò ÌôïÏù∏ (GET ÏöîÏ≤≠)
            fetch(`/review/like-status/${reviewproductIdx}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            })
                .then(response => response.json())
                .then(data => {
                    heartIcon.textContent = data.status === "liked" ? "‚ù§Ô∏è" : "üñ§";
                    likeCountSpan.textContent = data.likeCount; // Ï¢ãÏïÑÏöî Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
                })
                .catch(error => console.error("Error:", error));

            // Í∞úÎ≥Ñ Ï∞ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            btn.addEventListener("click", function () {
                fetch(`/review/like/${reviewproductIdx}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include"
                })
                    .then(response => {
                        if (response.status === 401) {
                            alert("Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.");
                            window.location.href = "/login";
                            return;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === "added") {
                            heartIcon.textContent = "‚ù§Ô∏è"; // Ï∞ú Ï∂îÍ∞ÄÎê®
                            likeCountSpan.textContent = parseInt(likeCountSpan.textContent) + 1; // Ïà´Ïûê Ï¶âÏãú Ï¶ùÍ∞Ä
                        } else if (data.status === "removed") {
                            heartIcon.textContent = "üñ§"; // Ï∞ú Ï∑®ÏÜåÎê®
                            likeCountSpan.textContent = parseInt(likeCountSpan.textContent) - 1; // Ïà´Ïûê Ï¶âÏãú Í∞êÏÜå
                        }
                    })
                    .catch(error => console.error("Error:", error));
            });
        });
    });
</script>
</html>