<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/user_like.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="user-like-container">
        <div class="product-list-head">
            <div class="product-font list-head">
                <h2 class="product-h2">ìƒí’ˆ ëª©ë¡</h2>
            </div>
            <div class="product-list-right">
                <div class="sortAll list-head">
                    <select id="sort" name="sort" onchange="changeSort()" required="required">
                        <option value="latest" th:selected="${sort == 'latest'}">ìµœì‹  ìˆœ</option>
                        <option value="comentst" th:selected="${sort == 'comentst'}">ëŒ“ê¸€ ìˆœ</option>
                        <option value="cheapst" th:selected="${sort == 'cheapst'}">ì œì¼ ë‚®ì€ ê°€ê²©</option>
                        <option value="expensivest" th:selected="${sort == 'expensivest'}">ì œì¼ ë¹„ì‹¼ ê°€ê²©</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="product-list">
            <div th:each="item : ${userLikes}" class="product-item">
                <div class="img-like">
                    <input type="hidden" name="product_buy_productidx" th:value="${item.product.product_idx}">
                    <button>â¤ï¸</button>
                </div>
                <a th:href="@{|/productDetail/${item.product.product_idx}|}">
                    <img th:src="@{${'/product-images/' + item.product.product_image.split(',')[0]}}" alt="ìƒí’ˆ ì´ë¯¸ì§€">
                </a>
                <div class="product-name" th:text="${item.product.productName}">ìƒí’ˆëª…</div>
                <div class="product-info">
                    <span class="like-price" th:text="${#numbers.formatInteger(item.product.product_price,3,'COMMA') + 'ì›'}"></span>
                    <span class="like">
                            <span>â¤ï¸</span>
                            <span class="product-like-count" th:text="${item.product.product_like}"></span>
                    </span>
                    <span class="comment" >
                            <span>ğŸ’¬</span>
                            <span th:text="${item.product.product_coment}"></span>
                    </span>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(userLikes)}" class="no-reviews">
                ì•„ì§ ì¢‹ì•„ìš” í•­ëª©ì´ ì¡´ì¬ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
</th:block>
</body>
</html>
<script>
    // ìƒí’ˆ ìƒì„¸ ì •ë³´ ì°œí•˜ê¸° API
    document.addEventListener("DOMContentLoaded", function () {
        const btns = document.querySelectorAll(".img-like");

        btns.forEach(btn => {
        const productIdx = btn.querySelector("input[name='product_buy_productidx']").value;
        const productItem = btn.closest(".product-item"); // ê°€ì¥ ê°€ê¹Œìš´ product-item ì°¾ê¸° ê·¸ë˜ì•¼ì§€ likeCount ê°’ì„ ì°¾ì„ìˆ˜ ìˆìŒ
        const likeCountSpan = productItem.querySelector(".product-like-count"); // ì¢‹ì•„ìš” ê°œìˆ˜ í‘œì‹œí•˜ëŠ” ìš”ì†Œ

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì°œ ìƒíƒœ í™•ì¸ (GET ìš”ì²­)
            fetch(`/product/like-status/${productIdx}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "liked") {
                        btn.textContent = "â¤ï¸"; // ì°œ ìƒíƒœì¸ ê²½ìš°
                        likeCountSpan.textContent = data.likeCount; // ì¢‹ì•„ìš” ê°œìˆ˜ ì—…ë°ì´íŠ¸
                    } else if (data.status === "not_liked") {
                        btn.textContent = "ğŸ–¤"; // ì°œ ìƒíƒœê°€ ì•„ë‹Œ ê²½ìš°
                        likeCountSpan.textContent = data.likeCount; // ì¢‹ì•„ìš” ê°œìˆ˜ ì—…ë°ì´íŠ¸
                    }
                })
                .catch(error => console.error("Error:", error));

            // ì°œ ë²„íŠ¼ í´ë¦­ ì‹œ í† ê¸€ (POST ìš”ì²­)
            btn.addEventListener("click", function () {
                fetch(`/product/like/${productIdx}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "added") {
                            btn.textContent = "â¤ï¸"; // ì°œ ì¶”ê°€ëœ ê²½ìš°
                            likeCountSpan.textContent = parseInt(likeCountSpan.textContent) + 1; // ìˆ«ì ì¦‰ì‹œ ì¦ê°€
                        } else if (data.status === "removed") {
                            btn.textContent = "ğŸ–¤"; // ì°œ ì·¨ì†Œëœ ê²½ìš°
                            likeCountSpan.textContent = parseInt(likeCountSpan.textContent) - 1; // ìˆ«ì ì¦‰ì‹œ ê°ì†Œ
                        }
                    })
                    .catch(error => console.error("Error:", error));
            });
        });
    });

    // ì •ë ¬ ê¸°ëŠ¥ API
    function changeSort() {
        let selectedSort = document.getElementById("sort").value;
        let currentUrl = new URL(window.location.href);

        currentUrl.searchParams.set("sort", selectedSort);  // sort íŒŒë¼ë¯¸í„° ì¶”ê°€ ë˜ëŠ” ë³€ê²½
        currentUrl.searchParams.set("page", 0); // ì •ë ¬ ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™


        window.location.href = currentUrl.toString(); // ìƒˆ URLë¡œ ì´ë™

    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì •ë ¬ ê°’ ì ìš©
    document.addEventListener("DOMContentLoaded", function () {
        const sortSelect = document.getElementById("sort");

        // URLì—ì„œ ê²€ìƒ‰ì–´(search)ì™€ ì •ë ¬ê°’(sort)ì„ ê°€ì ¸ì˜´
        const urlParams = new URLSearchParams(window.location.search);
        const urlSort = urlParams.get("sort"); // URLì—ì„œ sort ê°’ ê°€ì ¸ì˜¤ê¸°


        // URLì—ì„œ sort ê°’ì´ ìˆìœ¼ë©´ ë“œë¡­ë‹¤ìš´ì— ì„¤ì •í•˜ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
        if (urlSort) {
            sortSelect.value = urlSort;
        } else {
            sortSelect.value = "latest"; // ê¸°ë³¸ê°’ ì„¤ì •
        }
    });
</script>