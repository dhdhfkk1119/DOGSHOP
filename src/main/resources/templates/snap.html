<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <th:block th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/snap.css}">
  </th:block>
</head>
<body>
<th:block th:fragment="content">
  <!-- Ïä§ÎÉÖ ÌéòÏù¥ÏßÄ -->
    <div class="snap-container">
        <div class="profile-info">
          <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î∞è Ï†ïÎ≥¥ -->
            <div class="profile-image">
                <img th:src="@{${'/profile-images/' + UserImage}}" alt="Profile Image" id="snapProfileImage">
                <div class="user-name">
                  <span id="userName" th:text="${name}"></span>
                </div>
                <div class="user-creation-date">
                  <span id="userCreationDate" th:text="${#temporals.format(CreatAt, 'yyyy-MM-dd')}"></span>
                </div>
            </div>
            <div class="profile-details">
                <div class="review-count">
                    <div class="review-size">
                        <span id="reviewCount" th:text="${#lists.size(reviewList)}">0</span>
                        <span>Î¶¨Î∑∞</span>
                    </div>
                    <div class="answer-size">
                        <span id="reviewCount" th:text="${#lists.size(questions)}">0</span>
                        <span>QnA</span>
                    </div>
                </div>

                <!-- ÌîÑÎ°úÌïÑ Î≥ÄÍ≤Ω Î≤ÑÌäº -->
                <div class="profile-buttons">
                  <button id="changeProfileImageBtn" onclick="openImageChangeModal()">Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω</button>
                  <button id="changeNameBtn" onclick="openNameChangeModal()">Ïù¥Î¶Ñ Î≥ÄÍ≤Ω</button>
                </div>
            </div>
        </div>

        <!-- Î¶¨Î∑∞ ÏÑπÏÖò -->
        <div class="review-section review">
            <h3 class="select-section">
                <button class="section-btn">ÎÇ¥Í∞Ä Ïì¥ Î¶¨Î∑∞</button>
                <button class="section-btn">ÎÇ¥Í∞Ä Ïì¥ QnA</button>
            </h3>
            <div id="reviewList" class="review-container review" th:each="review : ${reviewList}">
                <div class="review-item">
                    <div class="review-left">
                        <div th:if="${reviewimages.containsKey(review.reviewIdx) and reviewimages[review.reviewIdx].length > 0}">
                            <img th:src="@{'/review-images/' + ${reviewimages[review.reviewIdx][0]}}"
                                 alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                                 class="review-img"
                                 onclick="openModel(this.src)">
                        </div>
                    </div>
                    <div class="review-content">
                        <div class="review-header">
                            <div class="review-stars" th:switch="${#numbers.formatInteger(review.reviewScope, 0)}">
                                <span th:case="1">‚≠ê</span>
                                <span th:case="2">‚≠ê‚≠ê</span>
                                <span th:case="3">‚≠ê‚≠ê‚≠ê</span>
                                <span th:case="4">‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                <span th:case="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                            </div>
                            <div class="review-user-info">
                                <span class="review-username" th:text="${review.reviewUser}"></span> |
                                <span class="review-date" th:text="${#temporals.format(review.reviewAt,'YYYY.MM.dd')}"></span> |
                                <span class="review-option" th:text="${name}"></span>
                            </div>
                        </div>
                        <div class="review-text" th:text="${review.reviewContent}">
                        </div>
                    </div>
                    <div class="like-button review-wishlist-btn">
                        <span>üñ§</span> <!-- Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ï∞úÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉú -->
                        <input type="hidden" name="review_idx" th:value="${review.reviewIdx}">
                        <span class="review-like-count" th:text="${review.reviewLike}"></span>
                    </div>
                </div>

                <!-- Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ -->
                <div id="image-modal" class="modal"  th:if="${reviewimages.containsKey(review.reviewIdx)}">
                    <div class="modal-inner">
                        <span class="close" onclick="closeModel()" >&times;</span>
                        <div class="modal-container-img">
                            <img th:each="image : ${reviewimages[review.reviewIdx]}"
                                 th:src="@{'/review-images/' + ${image}}"
                                 alt="Î¶¨Î∑∞ Ïù¥ÎØ∏ÏßÄ"
                                 class="modal-content" id="modal-img">
                        </div>
                        <img id="review-prev" class="review-prev" th:src="@{/local-images/left-arrow.png}" alt="">
                        <img id="review-next" class="review-next" th:src="@{/local-images/right-arrow.png}" alt="">
                        <div class="review-dots">
                            <span class="review-dot" th:each="i : ${#numbers.sequence(0, reviewimages[review.reviewIdx].length - 1)}"></span>
                        </div>
                    </div>
                </div>
            </div>


            <!--   ÏûêÏã†Ïù¥ ÏûëÏÑ±Ìïú QnA Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞            -->
            <div id="reviewList" class="review-container QnA" th:each="question : ${questions}">
                <div class="review-item answer-item">
                    <div class="review-left">
                        <div>
                            <a th:href="@{|/productDetail/${question.getProductQuestionProductidx()}|}">
                                <img class="review-img"
                                     th:src="@{'/product-images/' + ${questionProductMap[question.productQuestionIdx][1]}}"
                                     alt="ÏÉÅÌíà Ïù¥ÎØ∏ÏßÄ">
                            </a>
                        </div>
                    </div>
                    <div class="review-content">
                        <div class="review-header">
                            <div class="review-user-info">
                                <span class="review-username" th:text="'[' + ${questionProductMap[question.productQuestionIdx][0]} + ']'"></span> |
                                <span class="review-date" th:text="${#temporals.format(question.productQuestionAt,'YYYY.MM.dd')}"></span> |
                                <span class="review-option" th:text="${name}"></span>
                            </div>
                        </div>
                        <div class="review-text" th:text="${'ÏßàÎ¨∏ : ' + question.productQuestionContent}">
                        </div>
                        <div class="answer-text" th:text="${'ÎãµÎ≥Ä : ' + QuestionAnswerMap[question.getProductQuestionIdx()]}">
                        </div>
                    </div>
                    <div class="answer-btn">
                        <span>ÎãµÎ≥Ä</span>
                    </div>
                </div>
            </div>
        </div>


        <!-- snap ÏóêÏÑú question Ï†ïÎ≥¥ Î≥¥Ïó¨Ï£ºÍ∏∞       -->

        <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Î™®Îã¨ -->
        <div id="imageChangeModal" class="update-modal">
            <div class="popup-modal-content">
                <span class="update-close" onclick="closeImageChangeModal()">&times;</span>
                <h2>Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω</h2>
                <input type="file" id="newProfileImage" accept="image/*">
                <button class="update-btn" onclick="changeProfileImage()">Î≥ÄÍ≤ΩÌïòÍ∏∞</button>
            </div>
        </div>

            <!-- Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Î™®Îã¨ -->
        <div id="nameChangeModal" class="update-modal">
            <div class="popup-modal-content">
                <span class="update-close" onclick="closeNameChangeModal()">&times;</span>
                <input type="hidden" id="originalName">
                <h2>Ïù¥Î¶Ñ Î≥ÄÍ≤Ω</h2>
                <form id="profileImageForm" enctype="multipart/form-data">
                    <input type="text" id="newUserName" name="userImage" placeholder="ÏÉàÎ°úÏö¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    <button class="update-btn" onclick="changeUserName()">Î≥ÄÍ≤ΩÌïòÍ∏∞</button>
                </form>
            </div>
        </div>
    </div>



</th:block>
</body>
</html>
<script>

    // ÎãµÎ≥Ä Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú ÎãµÎ≥Ä Î≥¥Ïó¨Ï£ºÍ∏∞
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".answer-btn").forEach(button => {
            button.addEventListener("click", function () {
                const answerText = this.closest(".answer-item").querySelector(".answer-text");

                if (answerText.style.maxHeight && answerText.style.maxHeight !== "0px") {
                    // Îã´Í∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò
                    answerText.style.maxHeight = "0";
                    answerText.style.padding = "0";
                    answerText.style.opacity = "0";
                    setTimeout(() => {
                        answerText.style.display = "none"; // Ïï†ÎãàÎ©îÏù¥ÏÖò Ï¢ÖÎ£å ÌõÑ Ïà®ÍπÄ
                    }, 400); // CSS transition ÏãúÍ∞ÑÍ≥º ÎßûÏ∂§
                } else {
                    // Î®ºÏ†Ä displayÎ•º blockÏúºÎ°ú Î≥ÄÍ≤Ω
                    answerText.style.display = "block";

                    // ÏïΩÍ∞ÑÏùò ÏãúÍ∞Ñ Ï∞®Ïù¥Î•º Îë¨ÏÑú Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ïä§ÌÉÄÏùºÏùÑ Î∞òÏòÅÌï† Ïàò ÏûàÎèÑÎ°ù Ìï®
                    setTimeout(() => {
                        answerText.style.maxHeight = answerText.scrollHeight + "px";
                        answerText.style.padding = "10px 0";
                        answerText.style.opacity = "1";
                    }, 10); // 10ms Ï†ïÎèÑ ÎîúÎ†àÏù¥Î•º Ï§òÏÑú Î∞òÏòÅÎêòÎèÑÎ°ù Ìï®
                }
            });
        });
    });



    <!-- ÏÑπÏÖò Î≤ÑÌäºÏóê Îî∞Îùº Î≥¥Ïó¨Ï£ºÎäîÍ±∞ Îã§Î•¥Í≤å Î≥¥Ïó¨Ï£ºÍ∏∞  -->
    document.addEventListener("DOMContentLoaded", function () {
        const reviewBtn = document.querySelector(".section-btn:nth-child(1)"); // ÎÇ¥Í∞Ä Ïì¥ Î¶¨Î∑∞ Î≤ÑÌäº
        const qnaBtn = document.querySelector(".section-btn:nth-child(2)"); // ÎÇ¥Í∞Ä Ïì¥ QnA Î≤ÑÌäº
        const reviewSections = document.querySelectorAll(".review-container.review"); // Î¶¨Î∑∞ Î¶¨Ïä§Ìä∏
        const qnaSections = document.querySelectorAll(".review-container.QnA"); // QnA Î¶¨Ïä§Ìä∏

        function showReviews() {
            reviewSections.forEach(section => section.style.display = "block");
            qnaSections.forEach(section => section.style.display = "none");
            setActiveButton(reviewBtn);
        }

        function showQnAs() {
            reviewSections.forEach(section => section.style.display = "none");
            qnaSections.forEach(section => section.style.display = "block");
            setActiveButton(qnaBtn);
        }

        function setActiveButton(activeBtn) {
            document.querySelectorAll(".section-btn").forEach(btn => btn.classList.remove("active"));
            activeBtn.classList.add("active");
        }

        // Ï¥àÍ∏∞ ÏÉÅÌÉú: Î¶¨Î∑∞ Î≤ÑÌäº ÌôúÏÑ±Ìôî
        showReviews();

        reviewBtn.addEventListener("click", showReviews);
        qnaBtn.addEventListener("click", showQnAs);
    });




    // ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Î™®Îã¨ Ïó¥Í∏∞
  function openImageChangeModal() {
    document.getElementById("imageChangeModal").style.display = "flex";
  }

  // ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Î™®Îã¨ Îã´Í∏∞
  function closeImageChangeModal() {
    document.getElementById("imageChangeModal").style.display = "none";
  }

  // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Î™®Îã¨ Ïó¥Í∏∞
  function openNameChangeModal() {
    document.getElementById("nameChangeModal").style.display = "flex";
  }

  // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Î™®Îã¨ Îã´Í∏∞
  function closeNameChangeModal() {
    document.getElementById("nameChangeModal").style.display = "none";
  }

  // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω
  function changeUserName() {
      var rename = document.getElementById('newUserName').value;

      fetch("/snap/rename", {
          method: "POST",
          headers: {
              "Content-Type": "application/json"
          },
          body: JSON.stringify({
              rename: rename
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.status === "success") {
              alert(data.message);
              location.reload(); // Íµ¨Îß§ ÌõÑ ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® (Ïû•Î∞îÍµ¨Îãà ÎÇ¥Ïö© Í∞±Ïã†)
          } else {
              alert("Íµ¨Îß§ Ïã§Ìå®: " + data.message);
          }
      })
      .catch(error => console.error("Error:", error));

    closeNameChangeModal();
  }

  // ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω
  function changeProfileImage(){
      var fileInput = document.getElementById('newProfileImage');
      var file = fileInput.files[0]; // ÏÑ†ÌÉùÌïú ÌååÏùº Í∞ÄÏ†∏Ïò§Í∏∞

      if (!file) {
          alert("Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
          return;
      }

      var formData = new FormData();
      formData.append("file", file); // ÌååÏùº Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä

      fetch("/snap/newProfileImage", {
          method: "POST",
          body: formData // FormData Ï†ÑÏÜ° (Content-Type ÏûêÎèô ÏÑ§Ï†ïÎê®)
      })
          .then(response => response.json())
          .then(data => {
              if (data.status === "success") {
                  alert(data.message);
                  location.reload(); // ÏÑ±Í≥µ Ïãú ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
              } else {
                  alert("Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Ïã§Ìå®: " + data.message);
              }
          })
          .catch(error => console.error("Error:", error));
  }

  // ÌÅ¥Î¶≠Ïãú Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄ
  function openModel(src) {
      document.getElementById('image-modal').style.display = "flex";
      document.getElementById('modal-img').src = src;
  }


  // Ïù¥ÎØ∏ÏßÄ Îã´Í∏∞
  function closeModel() {
      document.getElementById('image-modal').style.display = "none";
  }

  // ESC ÌÇ§ ÎàåÎ†ÄÏùÑ Îïå Îã´Í∏∞
  document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
          closeModel();
      }
  });

  // ÏÉÅÌíà ÎåìÍ∏Ä Ï¢ãÏïÑÏöî API
  document.addEventListener("DOMContentLoaded", function () {
      const btns = document.querySelectorAll(".review-wishlist-btn");

      btns.forEach(btn => {
          const reviewproductIdx = btn.querySelector("input[name='review_idx']").value;
          const heartIcon = btn.querySelector("span"); // ‚ù§Ô∏è ÎòêÎäî üñ§ ÏïÑÏù¥ÏΩòÏùÑ Î≥ÄÍ≤ΩÌï† ÏöîÏÜå
          const likeCountSpan = btn.querySelector(".review-like-count"); // Ï¢ãÏïÑÏöî Í∞úÏàò ÌëúÏãúÌïòÎäî ÏöîÏÜå

          // Í∞úÎ≥Ñ Î¶¨Î∑∞Ïùò Ï∞ú ÏÉÅÌÉú Î∞è Í∞úÏàò ÌôïÏù∏ (GET ÏöîÏ≤≠)
          fetch(`/review/like-status/${reviewproductIdx}`, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
              credentials: "include"
          })
              .then(response => response.json())
              .then(data => {
                  heartIcon.textContent = data.status === "liked" ? "‚ù§Ô∏è" : "üñ§";
                  likeCountSpan.textContent = data.likeCount; // Ï¢ãÏïÑÏöî Í∞úÏàò ÏóÖÎç∞Ïù¥Ìä∏
              })
              .catch(error => console.error("Error:", error));

          // Í∞úÎ≥Ñ Ï∞ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
          btn.addEventListener("click", function () {
              fetch(`/review/like/${reviewproductIdx}`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include"
              })
                  .then(response => {
                      if (response.status === 401) {
                          alert("Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏãúÍ∏∞ Î∞îÎûçÎãàÎã§.");
                          window.location.href = "/login";
                          return;
                      }
                      return response.json();
                  })
                  .then(data => {
                      if (data.status === "added") {
                          heartIcon.textContent = "‚ù§Ô∏è"; // Ï∞ú Ï∂îÍ∞ÄÎê®
                          likeCountSpan.textContent = parseInt(likeCountSpan.textContent) + 1; // Ïà´Ïûê Ï¶âÏãú Ï¶ùÍ∞Ä
                      } else if (data.status === "removed") {
                          heartIcon.textContent = "üñ§"; // Ï∞ú Ï∑®ÏÜåÎê®
                          likeCountSpan.textContent = parseInt(likeCountSpan.textContent) - 1; // Ïà´Ïûê Ï¶âÏãú Í∞êÏÜå
                      }
                  })
                  .catch(error => console.error("Error:", error));
          });
      });
  });

  const reviewPrev = document.getElementById("review-prev");
  const reviewNext = document.getElementById("review-next");
  const reviewSlider = document.querySelector(".modal-container-img");
  const reviewImages = reviewSlider.querySelectorAll("img");  // Ïó¨Îü¨ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉù
  const reviewDots = document.querySelectorAll(".review-dot");
  let reviewCurrentIndex = 0;
  const reviewLength = reviewImages.length;

  function updateReDots(){
      reviewDots.forEach((dot,index) => {
          dot.classList.remove('active');
          if(index === reviewCurrentIndex){
              dot.classList.add("active");
          }
      });
  }

  reviewPrev.addEventListener('click', () => {
      if(reviewCurrentIndex > 0){  // Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏßÄ ÏïäÎèÑÎ°ù Ï°∞Í±¥ Î≥ÄÍ≤Ω
          reviewCurrentIndex--;
          reviewSlider.style.transform = `translateX(-${reviewCurrentIndex * 400}px)`;  // Î∞±Ìã±(`) ÏÇ¨Ïö©
          updateReDots();
      }
  });

  reviewNext.addEventListener('click', () => {
      if(reviewCurrentIndex < reviewLength - 1){  // ÎÅùÍπåÏßÄ Í∞ÄÏßÄ ÏïäÎèÑÎ°ù Ï°∞Í±¥ Î≥ÄÍ≤Ω
          reviewCurrentIndex++;
          reviewSlider.style.transform = `translateX(-${reviewCurrentIndex * 400}px)`;  // Î∞±Ìã±(`) ÏÇ¨Ïö©
          updateReDots();
      }
  });

  // ÎèôÍ∑∏ÎùºÎØ∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
  reviewDots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
          reviewCurrentIndex = index;
          reviewSlider.style.transform = `translateX(-${reviewCurrentIndex * 400}px)`;
          updateReDots();
      });
  });

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
  updateReDots();

</script>