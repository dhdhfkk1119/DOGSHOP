<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: html}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:fragment="css">
        <link rel="stylesheet" th:href="@{/css/cancel.css}">
    </th:block>
</head>
<body>
<th:block th:fragment="content">
    <div class="order-container">
        <div class="order-container-inner">
            <h2>ì·¨ì†Œ ë‚´ì—­</h2>

            <!-- ê²€ìƒ‰ì°½ -->
            <div class="search-container">
                <input type="text" class="search-box" name="search" id="search" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <span class="search-icon"><img th:src="@{/local-images/search-icon.png}" alt="" onclick="searchBtn()"></span>
            </div>
        </div>

        <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (í°ìƒ‰ ë°°ê²½) -->
        <div class="order-list" th:each="buyItem : ${buyItems}">
            <div class="order-item">
                <div class="order-header">
                    <span class="order-date" th:text="${#temporals.format(buyItem.productBuy.product_buy_at, 'yyyy-MM-dd')}"></span>
                    <p class="order-detail" onclick="orderDetail()">ì£¼ë¬¸ ìƒì„¸</p>
                </div>

                <div class="order-status">
                    <span th:if="${buyItem.productBuy.productStatus == 'cancel'}">ì·¨ì†Œ ì™„ë£Œ</span>
                </div>
                <div class="order-content">
                    <a th:href="@{|/productDetail/${buyItem.product.product_idx}|}">
                        <img th:src="@{${'/product-images/' + buyItem.product.product_image.split(',')[0]}}" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="order-image">
                    </a>
                    <div class="order-info">
                        <span class="item-name" th:text="${buyItem.product.productName}"></span>
                        <span class="item-quantity" th:text="${buyItem.productBuy.product_buy_quantity} + ê°œ"></span>
                        <span class="total-price" th:data-quantity="${buyItem.productBuy.product_buy_quantity}" th:data-price="${buyItem.product.product_price}">
                            <span class="calculated-price"></span>ì›
                        </span>
                    </div>
                    <div class="order-detail-info">
                        <div>
                            <span class="label">No.</span>
                            <span class="product-buy-idx info-span" th:text="${buyItem.product.product_idx}"></span>
                        </div>
                        <div>
                            <span class="label">íŒë§¤íšŒì‚¬ : </span>
                            <span class="product-buy-user info-span" th:text="${buyItem.product.product_user}"></span>
                        </div>
                        <div class="over-flow-content">
                            <span class="label">ì œí’ˆ ì„¤ëª… : </span>
                            <span class="product-buy-content info-span" th:text="${buyItem.product.productContent}"></span>
                        </div>
                    </div>

                </div>

                <!-- ì¬êµ¬ë§¤ ë²„íŠ¼ -->
                <div class="form-btn">
                    <a th:if="${buyItem.productBuy.productStatus == 'cancel'}" class="reorder-btn" th:href="@{|/productDetail/${buyItem.product.product_idx}|}">
                        ì¬êµ¬ë§¤ í•˜ê¸°
                    </a>
                </div>
            </div>
        </div>
        <div th:if="${#lists.isEmpty(buyItems)}" class="no-reviews">
            ì•„ì§ êµ¬ë§¤ë¥¼ ì·¨ì†Œí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
    </div>


</th:block>
</body>
</html>
<script>
    // ìˆ˜ëŸ‰ * ê°€ê²© í‘œì‹œ
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".total-price").forEach(span => {
            let price = parseInt(span.getAttribute("data-price"), 10); // ë¬¸ìì—´ â†’ ìˆ«ì ë³€í™˜
            let quantity = parseInt(span.getAttribute("data-quantity"), 10);
            let total = price * quantity;
            span.querySelector(".calculated-price").textContent = total.toLocaleString();
        });
    });

    // ê°ê° í´ë¦­í•œ ì •ë³´ì— ìƒì„¸ ì£¼ë¬¸ì„ ë³¼ìˆ˜ìˆë‹¤
    function orderDetail(event) {
        let orderItem = event.target.closest(".order-item"); // í´ë¦­í•œ ìš”ì†Œì˜ ë¶€ëª¨ order-item ì°¾ê¸°
        let detailInfo = orderItem.querySelector(".order-detail-info"); // í•´ë‹¹ ì£¼ë¬¸ ìƒì„¸ ì •ë³´ ì°¾ê¸°

        if (detailInfo.style.display === "none" || detailInfo.style.display === "") {
            detailInfo.style.display = "block";
            detailInfo.style.maxHeight = detailInfo.scrollHeight + "px";
            detailInfo.style.transform = "translateY(0px)";
        } else {
            detailInfo.style.maxHeight = "0px";
            detailInfo.style.transform = "translateY(-10px)";
            setTimeout(() => {
                detailInfo.style.display = "none";
            }, 300);
        }
    }

    // ëª¨ë“  "ì£¼ë¬¸ ìƒì„¸" ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll(".order-detail").forEach(button => {
        button.addEventListener("click", orderDetail);
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì •ë ¬ ê°’ ì ìš©
    document.addEventListener("DOMContentLoaded", function () {
        const inputsearch = document.getElementById("search");

        // URLì—ì„œ ê²€ìƒ‰ì–´(search)ì™€ ì •ë ¬ê°’(sort)ì„ ê°€ì ¸ì˜´
        const urlParams = new URLSearchParams(window.location.search);
        const urlSearch = urlParams.get("search"); // URLì—ì„œ search ê°’ ê°€ì ¸ì˜¤ê¸°

        // URLì—ì„œ search ê°’ì´ ìˆìœ¼ë©´ inputì— ì„¤ì •í•˜ê³ , ì—†ìœ¼ë©´ ë¹„ì›Œë‘ 
        if (urlSearch) {
            inputsearch.value = urlSearch;
        } else {
            inputsearch.value = ""; // ê²€ìƒ‰ì–´ê°€ ì—†ë‹¤ë©´ ë¹„ì›Œë‘ 
        }
    });

    function searchBtn(){
        let searchValue = document.getElementById("search").value.trim();

        const url = new URL(window.location);
        if (searchValue) {
            url.searchParams.set("search", searchValue); // ê²€ìƒ‰ì–´ ì¶”ê°€
        } else {
            url.searchParams.delete("search"); // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì œê±°
        }
        window.location.href = url.toString();
    }

    // ğŸ”¹ ì—”í„° í‚¤ ê°ì§€ ì´ë²¤íŠ¸ ì¶”ê°€
    document.getElementById("search").addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
            searchBtn();  // ì—”í„° í‚¤ ëˆ„ë¥´ë©´ ê²€ìƒ‰ ì‹¤í–‰
        }
    });

</script>